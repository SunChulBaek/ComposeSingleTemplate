version: 2.1
orbs:
  android: circleci/android@2.2.0 # https://circleci.com/developer/orbs/orb/circleci/android for latest version
  slack: circleci/slack@4.10.1
commands:
  install_android_gradle_dependencies:
    steps:
      - android/restore-gradle-cache
      - run:
          name: Download Dependencies
          command: ./gradlew androidDependencies
      - android/save-gradle-cache
  check_dependency_updates:
    parameters:
      revision:
        default: release
        type: string
      output:
        default: plain
        type: string
    steps:
      - run:
          name: Check Dependency Updates
          command: ./gradlew dependencyUpdates -Drevision=<<parameters.revision>> -DoutputFormatter=<<parameters.output>>
  set_build_properties:
    parameters:
      build-number:
        default: $CIRCLE_BUILD_NUM
        type: string
      build-version:
        default: 1.0.0
        type: string
    steps:
      - run:
          name: Set Build Properties
          command: sudo chmod +x ./setBuildProperties; ./setBuildProperties <<parameters.build-number>> "<<parameters.build-version>>"
  build_and_archive: # 여기는 좀 더 개선이 필요할듯
    parameters:
      command:
        default: assembleRelease
        type: string
      path:
        default: app/build/outputs/apk/release
        type: string
      source:
        default: app-release.apk
        type: string
      target:
        type: string
      destination:
        default: apk
        type: string
    steps:
      - run:
          name: Check Java Version
          command: java --version
      - run:
          name: Build Binaries
          command: ./gradlew <<parameters.command>>
      - run:
          name: Change File Name
          command: mv <<parameters.path>>/<<parameters.source>> <<parameters.path>>/<<parameters.target>>
      - store_artifacts:
          path: <<parameters.path>>
          destination: <<parameters.destination>>
  slack_notify:
    steps:
      - slack/notify:
          event: fail
          template: basic_fail_1
      - slack/notify:
          event: pass
          template: basic_success_1
jobs:
  build:
    executor:
      name: android/android-docker
      tag: 2023.04.1 # https://circleci.com/developer/images/image/cimg/android#image-tags
    steps:
      - checkout
      - android/change-java-version:
          java-version: 17
      - run:
          name: Chmod permissions # if permission for Gradlew Dependencies fail, use this.
          command: sudo chmod +x ./gradlew
      - android/create-keystore-properties:
          release-keystore: keystore
      - install_android_gradle_dependencies
      - check_dependency_updates
      - set_build_properties
      - build_and_archive:
          target: CSTemplate-v${CIRCLE_BUILD_NUM}.apk
      - slack_notify
workflows:
  build:
    jobs:
      - build